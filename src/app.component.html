
<!-- AUTH LOADING SCREEN -->
@if (isAuthLoading()) {
  <div class="min-h-screen bg-slate-900 flex items-center justify-center">
    <div class="text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-red-600 rounded-2xl mb-4 animate-pulse">
        <i class="fas fa-shield-alt text-3xl text-white"></i>
      </div>
      <p class="text-slate-400 text-sm">Verificando autenticación...</p>
    </div>
  </div>
}

<!-- LOGIN SCREEN -->
@else if (!isAuthenticated()) {
  <app-login></app-login>
}

<!-- MAIN APP -->
@else {
<div class="flex h-screen bg-slate-50 dark:bg-[#0f172a] font-sans overflow-hidden transition-colors duration-500" [class.dark]="plantMode()">

  <!-- SIDEBAR NAVIGATION -->
  <aside class="w-20 lg:w-64 bg-slate-900 text-slate-300 flex flex-col justify-between shrink-0 z-30 transition-all duration-300 shadow-xl">
    <div>
      <!-- Brand -->
      <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800 bg-slate-950">
        <i class="fas fa-network-wired text-[#ce1126] text-xl shadow-lg shadow-red-900/50 rounded-full"></i>
        <span class="ml-3 font-black text-white italic text-lg hidden lg:block tracking-tighter">ASSET GUARD</span>
      </div>

      <!-- Nav Items -->
      <nav class="p-2 lg:p-4 space-y-1 mt-2">
        <button (click)="setView('dashboard')"
                class="w-full flex items-center p-3 rounded-lg transition-all group relative border-l-4"
                [class.border-[#ce1126]]="currentView() === 'dashboard'"
                [class.bg-slate-800]="currentView() === 'dashboard'"
                [class.text-white]="currentView() === 'dashboard'"
                [class.border-transparent]="currentView() !== 'dashboard'"
                [class.hover:bg-slate-800]="currentView() !== 'dashboard'">
          <i class="fas fa-chart-pie w-6 text-center" [class.text-[#ce1126]]="currentView() === 'dashboard'"></i>
          <span class="ml-3 text-sm font-bold hidden lg:block">Resumen Ejecutivo</span>
          <div class="lg:hidden absolute left-14 bg-slate-900 text-white text-xs px-2 py-1 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 whitespace-nowrap border border-slate-700">Resumen</div>
        </button>

        <button (click)="setView('service')"
                class="w-full flex items-center p-3 rounded-lg transition-all group relative border-l-4"
                [class.border-orange-500]="currentView() === 'service'"
                [class.bg-slate-800]="currentView() === 'service'"
                [class.text-white]="currentView() === 'service'"
                [class.border-transparent]="currentView() !== 'service'"
                [class.hover:bg-slate-800]="currentView() !== 'service'">
          <i class="fas fa-wrench w-6 text-center" [class.text-orange-500]="currentView() === 'service'"></i>
          <span class="ml-3 text-sm font-bold hidden lg:block">Taller & Fallas</span>
          <div class="lg:hidden absolute left-14 bg-slate-900 text-white text-xs px-2 py-1 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 whitespace-nowrap border border-slate-700">Taller</div>
        </button>

        <button (click)="setView('assets')"
                class="w-full flex items-center p-3 rounded-lg transition-all group relative border-l-4"
                [class.border-blue-500]="currentView() === 'assets'"
                [class.bg-slate-800]="currentView() === 'assets'"
                [class.text-white]="currentView() === 'assets'"
                [class.border-transparent]="currentView() !== 'assets'"
                [class.hover:bg-slate-800]="currentView() !== 'assets'">
          <i class="fas fa-truck-moving w-6 text-center" [class.text-blue-500]="currentView() === 'assets'"></i>
          <span class="ml-3 text-sm font-bold hidden lg:block">Inventario Flota</span>
          <div class="lg:hidden absolute left-14 bg-slate-900 text-white text-xs px-2 py-1 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-50 whitespace-nowrap border border-slate-700">Flota</div>
        </button>

        <button (click)="setView('solicitor')"
                class="w-full flex items-center p-3 rounded-lg transition-all group relative border-l-4"
                [class.border-slate-500]="currentView() === 'solicitor'"
                [class.bg-slate-800]="currentView() === 'solicitor'"
                [class.text-white]="currentView() === 'solicitor'"
                [class.border-transparent]="currentView() !== 'solicitor'"
                [class.hover:bg-slate-800]="currentView() !== 'solicitor'">
          <i class="fas fa-mobile-alt w-6 text-center" [class.text-slate-400]="currentView() === 'solicitor'"></i>
          <span class="ml-3 text-sm font-bold hidden lg:block">App Operador</span>
        </button>
      </nav>
    </div>

    <!-- Bottom Actions -->
    <div class="p-2 lg:p-4 border-t border-slate-800 bg-slate-950">
      <button (click)="setView('settings')" class="w-full flex items-center p-3 rounded-xl hover:bg-slate-800 transition-colors text-slate-400 hover:text-white">
         <i class="fas fa-cog w-6 text-center"></i>
         <span class="ml-3 text-xs font-bold uppercase hidden lg:block">Configuración</span>
      </button>
      <div class="mt-4 text-center lg:text-left lg:px-3">
         <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest hidden lg:block">Planta Cuautitlán</p>
         <div class="text-[10px] text-slate-600 truncate mt-1">v2.1.0 Enterprise</div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT AREA -->
  <div class="flex-1 flex flex-col h-full overflow-hidden relative">

    <!-- TOPBAR -->
    <header class="h-16 bg-white dark:bg-[#1e293b] border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 shrink-0 z-20 transition-colors shadow-sm">

      <!-- Left: Title Context -->
      <div class="flex items-center gap-4">
         <div class="flex flex-col">
            <h2 class="text-sm font-bold text-slate-800 dark:text-white leading-tight">{{ viewTitle }}</h2>
            <div class="flex items-center gap-2 mt-0.5 group cursor-help">
               <!-- Dynamic Status Indicator -->
               <div class="relative flex h-2 w-2">
                 <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"
                       [class.bg-green-500]="connectionStatus() === 'online'"
                       [class.bg-amber-500]="connectionStatus() === 'syncing'"
                       [class.bg-red-500]="connectionStatus() === 'offline'"></span>
                 <span class="relative inline-flex rounded-full h-2 w-2"
                       [class.bg-green-500]="connectionStatus() === 'online'"
                       [class.bg-amber-500]="connectionStatus() === 'syncing'"
                       [class.bg-red-500]="connectionStatus() === 'offline'"></span>
               </div>

               <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide group-hover:text-slate-600 transition-colors">
                  {{ syncText() }}
               </span>

               <!-- Tooltip -->
               <div class="hidden group-hover:block absolute top-10 bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg whitespace-nowrap z-50">
                  Estado de conexión con Firebase Realtime DB
               </div>
            </div>
         </div>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center gap-6">
         <!-- User Profile with Logout -->
         <div class="flex items-center gap-3 text-right hidden sm:flex">
            <div>
               <p class="text-xs font-bold text-slate-700 dark:text-white">
                 {{ currentUser()?.displayName || 'Usuario' }}
               </p>
               <span class="inline-block bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider truncate max-w-[150px]">
                 {{ currentUser()?.email }}
               </span>
            </div>
            <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-slate-500 dark:text-slate-300 border border-slate-300 dark:border-slate-500">
               <i class="fas fa-user text-xs"></i>
            </div>
            <!-- Logout Button -->
            <button
              (click)="logout()"
              class="ml-2 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-slate-800 rounded-lg transition-all"
              title="Cerrar Sesión">
              <i class="fas fa-sign-out-alt"></i>
            </button>
         </div>

         <div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>

         <button (click)="toggleAiPanel()"
                 class="group relative flex items-center gap-2 px-3 py-1.5 text-slate-500 hover:text-[#ce1126] transition-colors rounded-lg hover:bg-red-50 dark:hover:bg-slate-800"
                 title="Asistente IA">
            <i class="fas fa-sparkles text-lg group-hover:rotate-12 transition-transform"></i>
            <span class="text-xs font-bold hidden md:inline">Asistente</span>
            @if (aiLoading()) {
              <span class="absolute top-1 right-1 flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
              </span>
            }
         </button>
      </div>
    </header>

    <!-- CONTENT SCROLL AREA -->
    <main class="flex-1 overflow-y-auto custom-scroll p-6 relative bg-[#f8fafc] dark:bg-[#0f172a]">
      <div class="fade-enter max-w-7xl mx-auto h-full pb-20">
        @switch (currentView()) {
          @case ('dashboard') { <app-dashboard /> }
          @case ('service') { <app-service-panel /> }
          @case ('assets') { <app-asset-list /> }
          @case ('solicitor') { <app-solicitor-panel /> }
          @case ('settings') { <app-admin /> }
        }
      </div>
    </main>

    <!-- FLOATING AI PANEL (DRAWER) -->
    <div class="fixed inset-y-0 right-0 w-[400px] bg-white dark:bg-[#1e293b] shadow-2xl transform transition-transform duration-300 z-50 border-l border-slate-200 dark:border-slate-700 flex flex-col"
         [class.translate-x-full]="!showAiPanel()"
         [class.translate-x-0]="showAiPanel()">

       <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-gradient-to-r from-slate-900 to-slate-800 text-white">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#ce1126] to-red-600 flex items-center justify-center shadow-lg shadow-red-900/50">
               <i class="fas fa-robot text-lg"></i>
            </div>
            <div>
               <h3 class="font-bold text-lg leading-tight">Gemini Assistant</h3>
               <p class="text-[10px] text-slate-300 opacity-80 uppercase tracking-widest">AssetGuard Intelligence</p>
            </div>
          </div>
          <button (click)="toggleAiPanel()" class="text-white/60 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
       </div>

       <!-- Chat Content -->
       <div class="flex-1 overflow-y-auto p-6 custom-scroll bg-slate-50 dark:bg-slate-900/50">
          @if (aiLoading()) {
             <div class="flex flex-col items-center justify-center py-10 space-y-4 text-slate-400 h-full">
                <div class="relative">
                   <i class="fas fa-circle-notch fa-spin text-4xl text-[#ce1126]"></i>
                   <i class="fas fa-brain absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs text-[#ce1126]"></i>
                </div>
                <p class="text-xs uppercase font-bold tracking-widest animate-pulse text-center">Analizando flota en tiempo real...</p>
             </div>
          } @else if (aiInsights()) {
             <div class="prose prose-sm prose-slate dark:prose-invert max-w-none bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700" [innerHTML]="aiInsights()"></div>
          } @else {
             <div class="flex flex-col items-center justify-center h-full text-center py-10 opacity-60 space-y-6">
                <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center">
                   <i class="fas fa-lightbulb text-4xl text-slate-400 dark:text-slate-500"></i>
                </div>
                <div>
                   <h4 class="font-bold text-slate-700 dark:text-slate-300 text-lg">¿Cómo puedo ayudarte?</h4>
                   <p class="text-xs text-slate-500 mt-2 max-w-[240px] mx-auto leading-relaxed">
                      Utilizo los datos actuales de fallas, costos y disponibilidad para generarte reportes al instante.
                   </p>
                </div>
             </div>
          }
       </div>

       <!-- Quick Actions Footer -->
       <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 space-y-2.5 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Acciones Sugeridas</p>

          <button (click)="generateExecutiveSummary()" class="w-full flex items-center p-3 bg-slate-50 dark:bg-slate-700 hover:bg-[#ce1126] hover:text-white dark:hover:bg-[#ce1126] rounded-lg border border-slate-200 dark:border-slate-600 hover:border-transparent transition-all group text-left">
             <div class="w-8 h-8 rounded bg-white dark:bg-slate-600 text-slate-600 dark:text-slate-300 flex items-center justify-center mr-3 group-hover:text-[#ce1126] shadow-sm">
                <i class="fas fa-file-alt"></i>
             </div>
             <div>
                <span class="block text-xs font-bold text-slate-700 dark:text-white group-hover:text-white">Resumen Ejecutivo del Día</span>
                <span class="block text-[10px] text-slate-400 group-hover:text-red-100">Estado general y cumplimiento</span>
             </div>
          </button>

          <button (click)="generateExecutiveSummary()" class="w-full flex items-center p-3 bg-slate-50 dark:bg-slate-700 hover:bg-amber-500 hover:text-white rounded-lg border border-slate-200 dark:border-slate-600 hover:border-transparent transition-all group text-left">
             <div class="w-8 h-8 rounded bg-white dark:bg-slate-600 text-slate-600 dark:text-slate-300 flex items-center justify-center mr-3 group-hover:text-amber-500 shadow-sm">
                <i class="fas fa-exclamation-triangle"></i>
             </div>
             <div>
                <span class="block text-xs font-bold text-slate-700 dark:text-white group-hover:text-white">Explicar Riesgos Operativos</span>
                <span class="block text-[10px] text-slate-400 group-hover:text-amber-100">Causas de baja disponibilidad</span>
             </div>
          </button>

          <button (click)="generateExecutiveSummary()" class="w-full flex items-center p-3 bg-slate-50 dark:bg-slate-700 hover:bg-emerald-600 hover:text-white rounded-lg border border-slate-200 dark:border-slate-600 hover:border-transparent transition-all group text-left">
             <div class="w-8 h-8 rounded bg-white dark:bg-slate-600 text-slate-600 dark:text-slate-300 flex items-center justify-center mr-3 group-hover:text-emerald-600 shadow-sm">
                <i class="fas fa-check-double"></i>
             </div>
             <div>
                <span class="block text-xs font-bold text-slate-700 dark:text-white group-hover:text-white">Sugerir Acciones de Mejora</span>
                <span class="block text-[10px] text-slate-400 group-hover:text-emerald-100">Optimización de flota</span>
             </div>
          </button>
       </div>
    </div>

    <!-- ASSET DETAIL MODAL (GLOBAL) -->
    @if (selectedAssetId()) {
      <div class="fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 fade-enter">
         <div class="w-full max-w-5xl max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl border border-white/10">
           <app-asset-detail [assetId]="selectedAssetId()!" />
         </div>
      </div>
    }

  </div>
</div>
} <!-- End of @else (authenticated) -->
